用于vue3 + django3 + drf + gunicorn + celery + nginx + redis + mysql 的部署方案

# 部署
https://mp.weixin.qq.com/s?__biz=MjM5OTMyODA4Nw==&mid=2247485718&idx=1&sn=836d1b8170f2ecf05ca928d9ec012469&chksm=a73c692e904be038e33202b656acafea2ebcb73e40cd4f49fe89fcf5a5d2bd125145bef71656&scene=126&sessionid=1622539812&key=53f59223bb025ab09255b52ba87c9c894f027a3b848b34cd0c128515143f1f46f41e7ff57338c9177195cbe22671a07755acd2450c7fe398035035609cf8b90fdbcfdb6334d38a201dfb7e96880cdad0395bdb0fe4a34bfa440b7423a2c1f1559ed3f81f1f31936ecfe47742786fbe14be54d0396c8a6813612b685bd4830767&ascene=1&uin=MjI0Mzc2NDk2Mg%3D%3D&devicetype=Windows+XP1&version=63000039&lang=zh_CN&exportkey=A5ILeRSGJi2YAZbeSX9lqwU%3D&pass_ticket=GB9n7FjwflXLl7GfyDZYqSCmaQszGVbOqOXU5eHqJ8smDzDIr41WDQtWgZQk7AWk&wx_header=0

1. vue构建dist文件: `yarn run build`
2. django的dockerfile
```dockerfile

# 建立 python 3.9环境
FROM python:3.9

# 安装netcat
RUN apt-get update && apt install -y netcat

# 容器内创建 myproject 文件夹
ENV APP_HOME=/var/www/html/myproject
# 给start.sh可执行权限
RUN mkdir -p $APP_HOME && chmod +x ./start.sh
WORKDIR $APP_HOME

# 将当前目录加入到工作目录中（. 表示当前目录）
ADD . $APP_HOME

# 更新pip版本 下载依赖 运行celery 运行beat
RUN /usr/local/bin/python -m pip install --upgrade pip && pip install -r requirements/production.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/ && celery multi start w1 -A demo -l info --pidfile=./celery/%n.pid --logfile=./celery/%n%I.log && celery -A demo beat -l info --detach --logfile=./celery/%n.log

# 安装项目依赖
RUN 

# 进程数
ENV WORKER=4

# 数据迁移， 启动服务
ENTRYPOINT /bin/bash ./start.sh
```
```sh
python manage.py makemigrations&&
python manage.py migrate&&
gunicorn myproject.asgi:application -w ${WORKER} -k uvicorn.workers.UvicornWorker
```
3. nginx的dockerfile
```dockerfile
FROM nginx:latest

RUN rm /etc/nginx/conf.d/default.conf

# 添加配置文件
ADD ./nginx.conf /etc/nginx/conf.d/
ADD ./dist /usr/share/nginx/html/static
```
4. nginx配置
```nginx
upstream django {
    server web:8000;
}

# 配置http请求，80端口
server {
    listen 80; # 监听80端口
    server_name 127.0.0.1; # 可以是nginx容器所在ip地址或127.0.0.1，不能写宿主机外网ip地址

    charset utf-8;
    client_max_body_size 10M; # 限制用户上传文件大小

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    location /api {
        proxy_pass http://django;   
    }

    location /media {
        alias /usr/share/nginx/html/media; # 媒体资源，用户上传文件路径
    }

    location / {
        root   /usr/share/nginx/html/static;
        index  index.html index.htm;
    }
}
```
5. mysql环境变量和配置
```
MYSQL_ROOT_PASSWORD=123456
MYSQL_DATABASE=myproject
MYSQL_USER=dbuser
MYSQL_PASSWORD=password
```
配置: 用于避免弹出警告提示
```
[client]
user=${MYSQL_USER}
password=${MYSQL_PASSWORD}
```
6. docker-compose.yml
```yaml

version: "3"

volumes: # 自定义数据卷
  db_vol: #定义数据卷同步存放容器内mysql数据
  redis_vol: #定义数据卷同步存放redis数据
  media_vol: #定义数据卷同步存放web项目用户上传到media文件夹的数据
  static_vol: #定义数据卷同步存放web项目static文件夹的数据
  celery_vol: # celery日志

networks: # 自定义网络(默认桥接)
  net:
    driver: bridge

services:
  redis:
    image: redis:latest
    # command: redis-server /etc/redis/redis.conf # 容器启动后启动redis服务器
    networks:
      - net
    volumes:
      - redis_vol:/data # 通过挂载给redis数据备份
      - ./compose/redis/redis.conf:/etc/redis/redis.conf # 挂载redis配置文件
    ports:
      - "6379:6379"
    restart: always # always表容器运行发生错误时一直重启

  db:
    image: mysql
    env_file:  
      - ./compose/mysql/.env # 使用了环境变量文件
    networks:  
      - net
    volumes:
      - db_vol:/var/lib/mysql:rw # 挂载数据库数据, 可读可写
      # - ./compose/mysql/init:/docker-entrypoint-initdb.d/ # 挂载数据初始化sql脚本
      - ./compose/mysql/conf/my.cnf:/etc/mysql/my.cnf # 挂载配置文件
    ports:
      - "3306:3306" # 与配置文件保持一致
    restart: always
    healthcheck:  # 用于判断mysql启动成功
        test: ["CMD", "mysqladmin", "-p"]
        interval: 1m30s  # 间隔
        timeout: 10s  # 超时
        retries: 3  #重试
        start_period: 40s # 启动40秒后

  web:
    build: ./myproject
    expose:
      - "8000"
    volumes:
      - ./myproject:/var/www/html/myproject # 挂载项目代码
      # - static_vol:/var/www/html/myproject/static # 以数据卷挂载容器内static文件
      - media_vol:/var/www/html/myproject/media # 以数据卷挂载容器内用户上传媒体文件
      - ./compose/logs:/tmp # 挂载gunicorn和celery日志
    networks:
      - net
    depends_on:
      - db
      - redis
    restart: always
    tty: true
    stdin_open: true

  nginx:
    build: ./compose/nginx
    ports:
      - "80:80"
      - "443:443"
    expose:
      - "80"
    volumes:
      - ./compose/nginx/nginx.conf:/etc/nginx/conf.d/nginx.conf # 挂载nginx配置文件
      - ./compose/nginx/log:/var/log/nginx # 挂载日志
      - static_vol:/usr/share/nginx/html/static # 挂载静态文件
      - media_vol:/usr/share/nginx/html/media # 挂载用户上传媒体文件
    networks:
      - net
    depends_on:
      - web
    restart: always
```
7. 文件
```
myproject_docker # 项目根目录
├── compose # 存放各项容器服务的Dockerfile和配置文件
│   ├── mysql
│   │   ├── conf
│   │   │   └── my.cnf # MySQL配置文件
│   │   │   └── .env # 环境变量文件
│   │   └── init
│   │       └── init.sql # MySQL启动脚本
│   ├── nginx
│   │   ├── Dockerfile # 构建Nginx镜像所的Dockerfile
│   │   ├── log # 挂载保存nginx容器内日志log目录
│   │   ├── nginx.conf # Nginx配置文件
│   │   └── ssl # 如果需要配置https需要用到
│   ├── redis
│   └── logs # 挂载保存gunicorn和celery的日志
├── docker-compose.yml # 核心编排文件
└── myproject # 常规Django项目目录
    ├── Dockerfile # 构建Django+gunicorn镜像的Dockerfile
    ├── apps # 存放Django项目的各个apps
    ├── manage.py
    ├── myproject # Django项目配置文件
    │   ├── asgi.py
    │   ├── __init__.py
    │   ├── settings.py
    │   ├── urls.py
    │   └── wsgi.py
    ├── requirements.txt # Django项目依赖文件
    ├── start.sh # 启动Django+Uwsgi容器后要执行的脚本
    ├── media # 用户上传的媒体资源，如果没有需手动创建
    ├── static #搜集项目的静态文件夹，如果没有需手动创建
```