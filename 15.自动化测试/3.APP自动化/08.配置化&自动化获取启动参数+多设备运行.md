å®è·µä¸­å‘ç°ï¼Œå¦‚æœéœ€è¦è¿›è¡Œå¤šæœºå¹¶å‘ç­‰æƒ…å†µæ—¶

æ‰§è¡Œæœºäº”èŠ±å…«é—¨ï¼Œå„å‹å·ï¼Œå„ç‰ˆæœ¬éƒ½æœ‰

å¦‚æœé…ç½®é’ˆå¯¹æ¯å°æœºå†™æ­»ï¼Œå·¥ä½œé‡å°†éå¸¸çš„å¤§ï¼Œè€Œä¸”ä»£ç çš„é€šç”¨æ€§ä¹Ÿä¸é«˜ã€‚

å…¶ä¸­æ‰§è¡Œæœºä¸åŒçš„åœ°æ–¹åœ¨äº è®¾å¤‡å·åŠç³»ç»Ÿç‰ˆæœ¬å·ã€‚å…¶ä½™çš„å‚æ•°æ˜¯ç›¸åŒçš„ï¼Œä¸€ä»½é»˜è®¤å‚æ•°é…ç½®æ”¾ç½®äºyamlæ–‡ä»¶ä¸­

è®¾å¤‡å·å¯ä»¥é€šè¿‡adb å‘½ä»¤ `adb devices`ä¸­å¾—åˆ°

ç³»ç»Ÿç‰ˆæœ¬å·ç»è¿‡æ‰¾äº†äº›èµ„æ–™ä¹Ÿå¯ä»¥é€šè¿‡adbå‘½ä»¤ `adb shell getprop ro.build.version.release` å¾—åˆ°ç³»ç»Ÿç‰ˆæœ¬å·
![image.png](https://upload-images.jianshu.io/upload_images/20499241-a426fbad17b2df90.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

ç¿»äº†ç¿»pythonçš„åº“å‘ç° subprocessæ¯”os.systemåº“å¥½ç”¨ï¼Œå¯ä»¥è¿”å›æ‰§è¡Œç»“æœå’Œé”™è¯¯ä¿¡æ¯

yamlæ–‡ä»¶ï¼šè®¾ç½®ä¸€ä¸ªé»˜è®¤é…ç½®
```yaml
automationName: UiAutomator2
platformName: Android
platformVersion: 7.1.2
deviceName: Android Emulator
appPackage: com.autonavi.minimap
appActivity: com.autonavi.map.activity.SplashActivity
noReset: True
```
å®ä¾‹ï¼š
è·å–è®¾å¤‡ååˆ—è¡¨
```python
In [1]: command = "adb devices"

In [2]: import subprocess

In [4]: out, err = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True).communicate()

In [5]: print(out)  # bytesæ ¼å¼
b'List of devices attached\r\nemulator-5554\tdevice\r\n\r\n'

In [6]: print(err)
b''

In [7]: out = str(out, encoding="utf8")  # è½¬åŒ–ä¸ºstræ ¼å¼

In [8]: print(out)
List of devices attached
emulator-5554   device

In [13]: out = out.strip()  # å»é™¤å¤´å°¾å­—ç¬¦ã€ç©ºç™½ç¬¦(åŒ…æ‹¬\nã€\rã€\tã€' 'ï¼Œå³ï¼šæ¢è¡Œã€å›è½¦ã€åˆ¶è¡¨ç¬¦ã€ç©ºæ ¼)

In [14]: out = out.split("\r\n")  # \r\n â†’ r\n ä¸ºæ¢è¡Œç¬¦ï¼ŒæŒ‰è¡Œä¸ºå•ä½è¿›è¡Œåˆ‡ç‰‡

In [15]: print(out)
['List of devices attached', 'emulator-5554\tdevice']

In [16]: out.remove("List of devices attached")  # é¦–è¡Œä¹Ÿå«â€œdeviceâ€ï¼Œæ‰€ä»¥å»é™¤å¹²æ‰°ä¿¡æ¯

In [17]: uuid = []  # å£°æ˜ç”¨äºå­˜æœ‰æ•ˆä¿¡æ¯çš„åˆ—è¡¨

In [20]: for item in out:
    ...:     print(item)
    ...:     if "device" in item:  # åˆ¤æ–­è®¾å¤‡æ˜¯å¦ä¸º"device"è¿™ç§æ­£å¸¸çŠ¶æ€
    ...:         item = item.split("\t")  # å°†è¿™è¡Œä¿¡æ¯è¿›è¡Œåˆ‡ç‰‡ï¼Œä»¥ \tğŸ‘‰åˆ¶è¡¨ç¬¦ä¸ºå•ä½
    ...:         print(item)
    ...:         uuid.append(item[0])  # å°†åˆ‡ç‰‡å¥½çš„è®¾å¤‡åæ”¾å…¥åˆ—è¡¨ä¸­
    ...: 
    ...: 
emulator-5554   device
['emulator-5554', 'device']



In [21]: print(uuid)
['emulator-5554']

In [22]: print(uuid[0])  # ä½¿ç”¨æ—¶å¯¹åˆ—è¡¨è¿›è¡Œéå†å³å¯
'emulator-5554'
```
è·å–ç³»ç»Ÿç‰ˆæœ¬å·åˆ—è¡¨
```python
In [27]: uuid
Out[27]: ['emulator-5554']

In [28]: command = "adb -s {} shell getprop ro.build.version.release"  # é€šè¿‡æŒ‡å®šè®¾å¤‡å·è·å–ç³»ç»Ÿç‰ˆæœ¬

In [33]: for id in uuid:
    ...:     out, err = subprocess.Popen(command.format(id), stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True).communicate()
    ...:     print(out)
    ...:     out = str(out, encoding="utf8")
    ...:     b.append(out.strip("\r\n"))
    ...: 
'7.1.2\r\n'

In [34]: b
Out[34]: ['7.1.2']

In [39]: list(zip(uuid, b))
Out[39]: [('emulator-5554', '7.1.2')]  # è®¾å¤‡å·ä¸ç‰ˆæœ¬å·çš„å…ƒç»„åˆ—è¡¨
```
cmd.py ï¼š å°è£…execute commandçš„æ“ä½œåŠä¿¡æ¯
```python
import subprocess


class Command:

    def cmd_run(self, command):
        try:
            out, err = \
                subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True).communicate()
            out = str(out, encoding="utf8").strip()  # å»é™¤å¤´å°¾å­—ç¬¦ã€ç©ºç™½ç¬¦(åŒ…æ‹¬\nã€\rã€\tã€' 'ï¼Œå³ï¼šæ¢è¡Œã€å›è½¦ã€åˆ¶è¡¨ç¬¦ã€ç©ºæ ¼)
            err = str(err, encoding="uft8").strip()
            if err:
                raise Exception(f"run command error msg:{err}")
        except:
            raise
        else:
            return out

    def devices_and_version(self):
        devices_uuid = self.__get_devices()
        versions = self.__get_version()
        res = list(zip(devices_uuid, versions))
        return res

    def __get_devices(self):
        command = "adb devices"
        res = self.cmd_run(command)
        if "\r\n" in res:  # windows newline == \r\n  é’ˆå¯¹ä¸åŒç³»ç»Ÿ
            res = res.split("\r\n")
        if "\n" in res:  # linux newline == \n
            res = res.split("\n")
        res.remove("List of devices attached")
        devices = []
        for item in res:
            if "device" in item:
                device = item.split("\t")[0]
                devices.append(device)
        return devices

    def __get_version(self):
        uuids = self.__get_devices()
        command = "adb -s {} shell getprop ro.build.version.release"
        versions = []
        for uuid in uuids:
            version = self.cmd_run(command.format(uuid))
            versions.append(version)
        return versions


cmd = Command()
print(cmd.devices_and_version())
```
appè‡ªåŠ¨åŒ–ä¸GUIè‡ªåŠ¨åŒ–å¤šçº¿ç¨‹ä¸Šæœ‰ä¸€ç‚¹ä¸åŒ

appæ¯æ¬¡ä»…å¯å¯åŠ¨ä¸€æ¬¡ï¼ŒGUIæµè§ˆå™¨å¯¹è±¡å¯ä»¥å¯åŠ¨å¤šä¸ª

æ ¹æ®è¾“å…¥å‚æ•°ï¼Œçµæ´»åº”ç”¨ï¼Œè‡ªå¯åŠ¨appium serveræœåŠ¡

å‰æï¼šå®‰è£…appium server [https://www.jianshu.com/p/2e06d1dc003c](https://www.jianshu.com/p/2e06d1dc003c)

[appium server å‘½ä»¤è¡Œæ“ä½œ](https://appium.io/docs/en/writing-running-appium/server-args/)
start.py
```python
import yaml
from appium import webdriver
from appium.webdriver.appium_service import AppiumService  # ç”¨äºå¯åŠ¨appium server
from command import Command


def base_args(*port, **kwargs):
    file = "./conf/caps.yaml"  # è®¾å®šyamlæ–‡ä»¶
    with open(file, "r") as file:
        caps = yaml.full_load(file)
    cmd = Command()
    info = cmd.devices_and_version()
    n = 0
    if kwargs:
        for key, value in kwargs.items():
            caps[key] = value
    for res in info:  # è‹¥éœ€è¦å¤šå°æœºå¯åœ¨æ­¤å¤„è¿›è¡Œå¤šçº¿ç¨‹æ“ä½œ,æœ¬å®ä¾‹åªæ¶‰åŠå¤šè®¾å¤‡è¿è¡Œ
        caps["deviceName"] = res[0]
        caps["platformVersion"] = res[1]
        service = AppiumService()  # å®ä¾‹åŒ–å¯¹è±¡
        if not port:  # å¦‚æœæœªæŒ‡å®športåˆ™é»˜è®¤
            port = ["4444"]
        service.start(args=["-a", "127.0.0.1", "-p", port[n], "--session-override"], timeout_ms=2000)  # å¯åŠ¨appium server æœ¬æ¥æ­¤å¤„æ‰“ç®—è‡ªå·±å†™çš„ åæ¥å‘ç°appiumåº“å·²ç»æä¾›æ–¹æ³•
        driver = webdriver.Remote(command_executor='http://127.0.0.1:{}/wd/hub'.format(port[n]),
                                  desired_capabilities=caps)
        yield driver  # å°†é©±åŠ¨å¯¹è±¡returnå‡ºå»
        service.stop()  # å…³é—­å½“å‰appium server
```